{"version":3,"sources":["../../source/controllers/admin.js"],"names":["admin","express","Router","storage","multer","memoryStorage","upload","get","req","res","currentUser","user","render","post","array","category","body","categoryMasterList","Category","findOne","catch","err","console","log","categorySet","Set","entries","add","newCategories","Array","from","save","files","forEach","file","newMidi","MIDIFile","originalname","re","regexedTitle","replace","title","library","midiJS","buffer","pianoVersion","data","Buffer","getContent","redirect"],"mappings":";;;;;;;;;;;AAEA;;AACA;;AAMA;;AACA;;AAEA;;AACA;;AACA;;;;AAdA;AAIA,MAAMA,KAAK,GAAGC,iBAAQC,MAAR,EAAd;;AACA,MAAMC,OAAO,GAAGC,gBAAOC,aAAP,EAAhB;;AACA,MAAMC,MAAM,GAAG,qBAAO;AAAEH,EAAAA,OAAO,EAAEA;AAAX,CAAP,CAAf,C,CAEA;;AAQAH,KAAK,CAACO,GAAN,CAAU,GAAV,EAAe,CAACC,GAAD,EAAMC,GAAN,KAAc;AACzB,QAAMC,WAAW,GAAGF,GAAG,CAACG,IAAxB;AACAF,EAAAA,GAAG,CAACG,MAAJ,CAAW,OAAX,EAAoB;AAAEF,IAAAA;AAAF,GAApB;AACH,CAHD;AAKAV,KAAK,CAACa,IAAN,CAAW,SAAX,EAAsBP,MAAM,CAACQ,KAAP,CAAa,OAAb,EAAsB,EAAtB,CAAtB,EAAiD,OAAON,GAAP,EAAYC,GAAZ,KAAoB;AACjE,QAAMM,QAAQ,GAAGP,GAAG,CAACQ,IAAJ,CAASD,QAA1B,CADiE,CAGjE;;AACA,MAAIE,kBAAkB,GAAG,MAAMC,kBAASC,OAAT,CAAiB,EAAjB,EAAqBC,KAArB,CAA2BC,GAAG,IAAI;AAAEC,IAAAA,OAAO,CAACC,GAAR,CAAYF,GAAZ;AAAkB,GAAtD,CAA/B;AACA,MAAIG,WAAW,GAAG,IAAIC,GAAJ,CAAQR,kBAAkB,CAACS,OAA3B,CAAlB;AACAF,EAAAA,WAAW,CAACG,GAAZ,CAAgBZ,QAAhB;AACA,MAAIa,aAAa,GAAGC,KAAK,CAACC,IAAN,CAAWN,WAAX,CAApB;AACAP,EAAAA,kBAAkB,CAACS,OAAnB,GAA6BE,aAA7B;AACAX,EAAAA,kBAAkB,CAACc,IAAnB,GAA0BX,KAA1B,CAAgCC,GAAG,IAAI;AAACC,IAAAA,OAAO,CAACC,GAAR,CAAYF,GAAZ;AAAkB,GAA1D,EATiE,CAWjE;;AACAb,EAAAA,GAAG,CAACwB,KAAJ,CAAUC,OAAV,CAAmB,MAAMC,IAAN,IAAc;AAC7B,QAAIC,OAAO,GAAG,IAAIC,iBAAJ,EAAd;AACAd,IAAAA,OAAO,CAACC,GAAR,CAAa,cAAaW,IAAI,CAACG,YAAa,EAA5C,EAF6B,CAG7B;;AACA,QAAIC,EAAE,GAAG,eAAT;AACA,QAAIC,YAAY,GAAGL,IAAI,CAACG,YAAL,CAAkBG,OAAlB,CAA0BF,EAA1B,EAA8B,EAA9B,CAAnB;AACAH,IAAAA,OAAO,CAACM,KAAR,GAAgBF,YAAhB;AACAJ,IAAAA,OAAO,CAACO,OAAR,GAAkB,IAAlB;AACAP,IAAAA,OAAO,CAACpB,QAAR,GAAmBA,QAAnB,CAR6B,CAU7B;;AACA,QAAI4B,MAAM,GAAG,uBAAST,IAAI,CAACU,MAAd,CAAb;AACA,QAAIC,YAAY,GAAG,sBAAQF,MAAR,CAAnB;AACAR,IAAAA,OAAO,CAACW,IAAR,GAAeC,MAAM,CAACjB,IAAP,CAAYe,YAAY,CAACG,UAAb,EAAZ,CAAf;AAEAb,IAAAA,OAAO,CAACJ,IAAR,GAAeX,KAAf,CAAqBC,GAAG,IAAI;AAAEC,MAAAA,OAAO,CAACC,GAAR,CAAYF,GAAZ;AAAmB,KAAjD;AACH,GAhBD;AAiBAZ,EAAAA,GAAG,CAACwC,QAAJ,CAAa,QAAb;AACH,CA9BD;eAgCejD,K","sourcesContent":["// admin.js\n\nimport express from 'express'\nimport multer from 'multer'\nconst admin = express.Router()\nconst storage = multer.memoryStorage()\nconst upload = multer({ storage: storage })\n\n// model\nimport MIDIFile from '../models/MIDIFile.js'\nimport Category from '../models/Category.js'\n\nimport readMIDI from '../lib/read-midi.js'\nimport pianize from '../lib/pianize.js'\nimport midiFile from 'midifile'\n\nadmin.get('/', (req, res) => {\n    const currentUser = req.user;\n    res.render('admin', { currentUser })\n})\n\nadmin.post('/upload', upload.array('midis', 64), async (req, res) => {\n    const category = req.body.category;\n\n    // update category master list\n    let categoryMasterList = await Category.findOne({}).catch(err => { console.log(err) });\n    let categorySet = new Set(categoryMasterList.entries);\n    categorySet.add(category);\n    let newCategories = Array.from(categorySet);\n    categoryMasterList.entries = newCategories;\n    categoryMasterList.save().catch(err => {console.log(err) });\n\n    // process files\n    req.files.forEach( async file => {\n        let newMidi = new MIDIFile();\n        console.log(`Processing ${file.originalname}`);\n        // let re = /^(.+)(\\.[^ .]+)?$/g;\n        let re = /(\\.[^ .]+)?$/g;\n        let regexedTitle = file.originalname.replace(re, '');\n        newMidi.title = regexedTitle;\n        newMidi.library = true;\n        newMidi.category = category;\n\n        // pianize the MIDI file\n        let midiJS = readMIDI(file.buffer);\n        let pianoVersion = pianize(midiJS);\n        newMidi.data = Buffer.from(pianoVersion.getContent());\n\n        newMidi.save().catch(err => { console.log(err); })\n    });\n    res.redirect('/admin')\n})\n\nexport default admin;\n"],"file":"admin.js"}